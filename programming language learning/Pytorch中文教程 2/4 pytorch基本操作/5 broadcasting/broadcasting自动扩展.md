- expand
- without copying data

关键点
- 从最小的维度开始匹配 从最前面的维度开始
![[Pasted image 20230509144600.png]]
- 自动调用expand函数让扩展的维度和目标的维度相同

![[Pasted image 20230509144641.png]]
现在存在这个size的feature maps
现在需要对其channel叠加偏置项
我们一般认为后边的维度是小维度 前边的是大维度
先从小维度开始对齐
![[Pasted image 20230509144847.png]]
这样我们的B 和 A 进行对其 还差一个维度
![[Pasted image 20230509144919.png]]
所以我们现在扩张这个维度为图中所示 1 x 4
![[Pasted image 20230509145004.png]]
最后一步就是从这个维度变为目标维度

正常的行列式相加如图所示
![[Pasted image 20230509145118.png]]
不需要进行扩展维度的变化

![[Pasted image 20230509145310.png]]
这就是使用broadcast的方法扩展B这个张量,使之可以和A 相加

有了broadcast功能, 我们就可以使不同维度的张量都可以相加
![[Pasted image 20230509145455.png]]
也就是unsqueeze 和 expand 进行结合的功能
而且是自动的一个工具

为什么需要broadcasting
1. 从实际的需求来看
- class students scores
- 需要给每个学生加5分
- 假设我们有4个班级 每个班级是32个学生 有8门课程
- 对应的矩阵size 就是4 32 8
- 需要对每个tensor加一个同shape的叠加 这里的5分是标量
- 所以我们需要调整到同一个维度去
![[Pasted image 20230509150030.png]]
如果要完成这个功能, 需要进行3个接口才能够获得这样的结果

我们按照一个浮点是4byte来计算, 如果使用repeat这种方式会多消耗1024倍的内存
![[Pasted image 20230509150402.png]]
总之这就是一个节省内存,节省操作的方法

**使用broadcast的需求**
- 现在有一大一小两个张量A & B 规定靠后的是较小的维度 前面的是较大的维度,这是根据实际物理意义来说的
![[Pasted image 20230509150616.png]]
- 从靠后的维度开始对其 也要根据实际物理意义来 比如每个人增加分数 就是从末尾的score维度开始的
- 如果现在的维度是1 就将维度扩展成 一样的
- 如果现在没有对应的维度,就增添一个1的维度 然后进行扩展到一样的目标维度
- 否则不能使用broadcasting

如果我们不是对所有的课程加5分 只是对单独的一门课程加5分
![[Pasted image 20230509151321.png]]
这样我们的最后一项就变成了1行8列的张量
也是可以对应到增加的内容里的

![[Pasted image 20230509151510.png]]
如果我增加一个1x4的张量, 就无法进行broadcasting

所以如果要进行broadcast 就需要把改变的作为最后一项

具体案例
- 有一个tensor 4 32 14 14 和另一个tensor 1 32 1 1 
![[Pasted image 20230509152409.png]]
就是再1 3 4的位置进行扩张

-  4  32  14  14 和 14  14
这个tensor相加的具体意思就是
现在存在一个对于所有像素添加一个bias的任务
不管是什么channel 或者什么图片 
所有的统一都需要添加bias
这个bias 的数值可以是不同的 也可以理解为图片底下叠加了一个已经确定的图
![[Pasted image 20230509152643.png]]

- 4 32 14 14 和 2 32 14 14
这个不符合我们的规定
这里只给了2个照片的参数
剩下2个照片的bias参数没有给出来
所以不能够使用broadcast
如果需要相加,就需要手动构建机制
![[Pasted image 20230509152854.png]]
也就是使用列表把0维度的提取出来后相加进去
同时把AB tensor的相同的维度提取出来 后边的需要增减添加bias的再相加

如何理解这种操作
![[Pasted image 20230509153141.png]]
这种就是一种约定,从最小的维度开始对齐

![[Pasted image 20230509153439.png]]
复习各种broadcast的意义
第一行是原来的tensor 我们理解为4张RGB图片有32x32像素
第二行是对于4张图片添加一个base照片, 再对应的像素点位置添加一个同样的bias
第三行是对于4张照片按照RGB通道不同进行调整 比如我R通道对于所有像素点添加1个0.5的bias GB 就不添加bias
第三行因为都是1 所以可以看作只有一个1 也就是对每一个像素都添加一个bias 不管通道和图片是什么 添加的都是相同的

